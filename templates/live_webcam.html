{% extends 'base.html' %}

{% block content %}
<div class="card p-5">
    <h1 class="card-header">Live Webcam Summary</h1>

    <!-- Webcam Video Stream -->
    <div class="mt-4">
        <video id="webcam" width="640" height="480" autoplay muted class="border rounded"></video>
    </div>

    <!-- Control Buttons -->
    <div class="mt-3">
        <button id="start-btn" class="btn btn-primary">Start Recording</button>
        <button id="stop-btn" class="btn btn-danger" disabled>Stop & Summarize</button>
    </div>

    <!-- Summary Output -->
    <div id="summary-result" class="mt-4" style="display: none;">
        <h3>Summary:</h3>
        <p id="summary-content" class="lead"></p>
        <button id="ask-question-btn" class="btn btn-secondary mt-3">Ask a Question</button>
    </div>

    <!-- Question Section -->
    <div id="question-section" class="mt-4" style="display: none;">
        <h4>Ask a Question About the Live Recording</h4>
        <form id="question-form">
            <div class="mb-3">
                <label for="user-question" class="form-label">Your Question:</label>
                <input type="text" id="user-question" class="form-control" placeholder="Type your question..." required>
            </div>
            <button type="submit" class="btn btn-success">Get Answer</button>
        </form>

        <!-- Answer Output -->
        <div id="question-result" class="mt-4" style="display: none;">
            <h5>Answer:</h5>
            <p id="answer-content" class="lead"></p>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="text-danger mt-4" style="display: none;"></div>
</div>

<script>
let mediaRecorder;
let recordedChunks = [];

const webcam = document.getElementById("webcam");
const startBtn = document.getElementById("start-btn");
const stopBtn = document.getElementById("stop-btn");
const summaryContent = document.getElementById("summary-content");
const summaryResult = document.getElementById("summary-result");
const errorMessage = document.getElementById("error-message");

// Access Webcam
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then((stream) => {
        webcam.srcObject = stream;

        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, { type: "video/mp4" });
            recordedChunks = [];

            const formData = new FormData();
            formData.append("video", blob, "webcam_recording.mp4");

            try {
                const response = await fetch("/live", {
                    method: "POST",
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    summaryContent.textContent = result.summary;
                    summaryResult.style.display = "block";
                    document.getElementById("ask-question-btn").dataset.videoName = result.filename;
                } else {
                    errorMessage.textContent = result.error || "Failed to summarize.";
                    errorMessage.style.display = "block";
                }
            } catch (err) {
                console.error(err);
                errorMessage.textContent = "Upload failed.";
                errorMessage.style.display = "block";
            }
        };
    })
    .catch((err) => {
        console.error("Webcam error:", err);
        errorMessage.textContent = "Could not access webcam.";
        errorMessage.style.display = "block";
    });

// Start Recording
startBtn.addEventListener("click", () => {
    recordedChunks = [];
    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
});

// Stop Recording
stopBtn.addEventListener("click", () => {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;
});

// Ask a Question
document.getElementById("ask-question-btn").addEventListener("click", () => {
    document.getElementById("question-section").style.display = "block";
});

// Question Form Submission
document.getElementById("question-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const videoName = document.getElementById("ask-question-btn").dataset.videoName;
    const question = document.getElementById("user-question").value;
    const answerContent = document.getElementById("answer-content");
    const questionResult = document.getElementById("question-result");

    questionResult.style.display = "none";
    errorMessage.style.display = "none";

    try {
        const response = await fetch("/ask_live", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `video_name=${encodeURIComponent(videoName)}&question=${encodeURIComponent(question)}`
        });

        const result = await response.json();

        if (response.ok) {
            answerContent.textContent = result.answer;
            questionResult.style.display = "block";
        } else {
            errorMessage.textContent = result.error || "An error occurred.";
            errorMessage.style.display = "block";
        }
    } catch (error) {
        console.error("Q&A error:", error);
        errorMessage.textContent = "Something went wrong while asking your question.";
        errorMessage.style.display = "block";
    }
});
</script>
{% endblock %}
